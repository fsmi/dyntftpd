#!/usr/bin/python

from cStringIO import StringIO
import tftpy
import re
import logging
import os
import file_ver_cmp
import filesys

logger = logging.getLogger('dyntftpd')

def return_newest_file(search_dir, prefix, path, match):
	prefix = prefix + '-'
	suffix = '-' + match.group(1)
	regex = '^%s.+%s' % (prefix, suffix)
	logger.debug("regex: %s" % regex)
	prog = re.compile(regex)
	logger.debug(os.listdir(search_dir))
	files = filter(prog.search, os.listdir(search_dir))
	logger.debug("found matching files: %s" % files)
	if len(files) > 0:
		newest_fn = os.path.join(search_dir,
				file_ver_cmp.highest_file_ver(prefix, suffix, files))
		logger.info("determined newest file: %s" % newest_fn)
		return open(newest_fn, 'rb')

def match(path, match):
	logger.debug('Matched "%s"' % path)
	return StringIO('This is a sample dynamic file.')

def main():
	logger.setLevel(logging.DEBUG)
	tftpy.setLogLevel(logging.DEBUG)

	image_dir = '/var/tmp/boot/'

	simul_fs = filesys.SimulatedFileSystem()
	simul_fs.add_handler('^/pxelinux.cfg/[0-9a-fA-F]{8}$', match)
	simul_fs.add_handler('^/vmlinuz-([^/]+)',
			lambda p, m: return_newest_file(image_dir, 'vmlinuz', p, m))
	simul_fs.add_handler('^/initrd-([^/]+)',
			lambda p, m: return_newest_file(image_dir, 'initrd', p, m))

	native_fs = tftpy.TftpNativeFileSys('./tftp')

	fss = filesys.FileSystemStack()
	fss.add_file_sys(native_fs)
	fss.add_file_sys(simul_fs)

	server = tftpy.TftpCommonServer(fss)
	try:
		server.listen('127.0.0.1', 2069)
	except KeyboardInterrupt:
		pass

if __name__ == '__main__':
	main()

# vim:set ft=python ts=4:
